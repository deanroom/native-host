# Native Hosting 解释

## 概念

Native Hosting 是指在任意非 .NET Core 生成的进程中托管 .NET 运行时的能力。它允许原生(非托管)应用程序加载和使用 .NET 运行时及其功能。

主要术语:

- "native host" - 使用 Native Hosting API 的代码,可以是任何非 .NET Core 应用程序。
- "hosting components" - 指 .NET Core 宿主组件,通常指 hostfxr 和 hostpolicy。
- "host context" - hostfxr 创建和维护的状态,代表对托管组件的一个逻辑操作。

## 机制

Native Hosting 主要通过以下步骤实现:

1. 定位和加载托管组件 - 原生主机如何找到并加载托管组件库。

2. 初始化主机上下文 - 为给定的托管代码输入初始化主机上下文。

3. 加载托管代码 - 确定要加载哪些托管代码,加载到哪里,并设置正确的输入以便运行时可以执行正确的依赖项解析。

4. 访问和执行托管代码 - 定位托管入口点并将其暴露给原生代码。

主要组件:

- nethost 库 - 提供定位正确 hostfxr 的方法。
- hostfxr - 提供初始化和管理主机上下文的 API。
- hostpolicy - 处理运行时配置和依赖项解析。

## 能力

Native Hosting 提供以下主要能力:

1. 运行托管应用程序
2. 加载托管组件并获取托管方法的原生函数指针
3. 获取已加载托管方法的原生函数指针  
4. 加载托管组件
5. 检查和修改运行时属性
6. COM 激活和注册
7. 内存中加载程序集

## 限制

主要限制包括:

1. 每个进程只能运行一个托管应用程序
2. 不支持同时加载多个 .NET Core 运行时版本
3. 不支持卸载已加载的托管组件
4. 与 trimming 不兼容,需要额外配置

## 应用场景

Native Hosting 可以解决以下应用场景:

1. 托管托管组件 - 原生主机加载托管程序集并调用其功能。支持并行加载多个这样的组件。

2. 托管托管应用 - 原生主机在进程内运行托管应用。基本上是现有 .NET Core 主机的不同实现。

3. 使用其他 .NET Core 托管服务 - 应用程序(原生或 .NET Core)需要使用 .NET Core 托管组件提供的其他服务,例如定位可用的 SDK 等。

4. 插件系统 - 允许原生应用程序动态加载和执行 .NET 插件。

5. 嵌入式脚本引擎 - 在原生应用程序中嵌入 .NET 运行时作为脚本引擎。

6. 跨语言互操作 - 允许非 .NET 语言编写的应用程序调用 .NET 代码。

7. 自定义应用程序加载器 - 实现自定义的 .NET 应用程序加载和执行逻辑。

8. 高级诊断和分析工具 - 允许原生诊断工具与 .NET 运行时交互以收集信息。

总的来说,Native Hosting 为非 .NET 应用程序提供了一种灵活的方式来利用 .NET 运行时和生态系统的强大功能,同时保持对加载和执行过程的精细控制。